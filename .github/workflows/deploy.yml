name: Deploy AI Vibez - DEBUG

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install
      - run: npm run build
        env:
          NODE_OPTIONS: '--max-old-space-size=8192'
          
      - name: Debug Deployment
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "=== CRITICAL FILE CHECK ==="
          echo "dist/_worker.js exists: $(test -f dist/_worker.js && echo 'YES' || echo 'NO - MISSING!')"
          if [ -d "dist" ]; then
            echo "Dist contents:"
            ls -la dist/
          fi
          
          echo "=== WRANGLER DEPLOY WITH FULL OUTPUT ==="
          set +e
          npx wrangler deploy --config wrangler.toml --verbose 2>&1 | tee deploy.log
          EXIT_CODE=$?
          
          echo "=== DEPLOYMENT LOG ==="
          cat deploy.log
          
          echo "=== WRANGLER ERROR LOGS ==="
          if [ -d ~/.config/.wrangler/logs ]; then
            for log in ~/.config/.wrangler/logs/*.log; do
              if [ -f "$log" ]; then
                echo "--- $log ---"
                cat "$log"
              fi
            done
          fi
          
          echo "Exit code: $EXIT_CODE"
          exit $EXIT_CODE
